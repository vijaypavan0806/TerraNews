const express = require('express');
const session = require('express-session');
const passport = require('passport');
const GoogleStrategy = require('passport-google-oauth20').Strategy;

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware for serving static files
app.use(express.static('public'));

// Middleware for session management
app.use(
    session({
        secret: 'your_secret_key', // Replace with a secure key
        resave: false,
        saveUninitialized: true,
    })
);

// Initialize Passport
app.use(passport.initialize());
app.use(passport.session());

// Passport serialization and deserialization
passport.serializeUser((user, done) => {
    done(null, user);
});

passport.deserializeUser((user, done) => {
    done(null, user);
});

// Configure Google OAuth Strategy
passport.use(
    new GoogleStrategy(
        {
            clientID: 'YOUR_GOOGLE_CLIENT_ID', // Replace with your Google client ID
            clientSecret: 'YOUR_GOOGLE_CLIENT_SECRET', // Replace with your Google client secret
            callbackURL: '/auth/google/callback',
        },
        (accessToken, refreshToken, profile, done) => {
            // Extract relevant profile data
            const user = {
                id: profile.id,
                username: profile.displayName,
                email: profile.emails[0].value,
                photo: profile.photos[0].value,
            };
            done(null, user);
        }
    )
);

// Routes
app.get('/', (req, res) => {
    res.sendFile(__dirname + '/public/index.html');
});

// Google OAuth login route
app.get('/auth/google', passport.authenticate('google', { scope: ['profile', 'email'] }));

// Google OAuth callback route
app.get(
    '/auth/google/callback',
    passport.authenticate('google', { failureRedirect: '/' }),
    (req, res) => {
        // Redirect to homepage on success
        res.redirect('/');
    }
);

// Logout route
app.get('/auth/logout', (req, res) => {
    req.logout(err => {
        if (err) {
            return next(err);
        }
        res.redirect('/');
    });
});

// API endpoint to fetch user details
app.get('/auth/user', (req, res) => {
    if (req.isAuthenticated()) {
        res.json(req.user); // Return user object stored in session
    } else {
        res.status(401).json({ error: 'User not authenticated' });
    }
});

// Error handling
app.use((err, req, res, next) => {
    console.error('Error:', err.message);
    res.status(500).json({ error: 'Internal server error' });
});

// Start the server
app.listen(PORT, () => {
    console.log(`Server running on http://localhost:${PORT}`);
});
